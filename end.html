<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VÃ½sledek â€“ VraÅ¾da v Reichenbergu</title>
  <link rel="stylesheet" href="assets/css/app.css" />
</head>
<body>
  <main class="page">
    <header class="hero">
      <h1>PÅ™Ã­pad uzavÅ™en</h1>
      <p class="muted" id="endingText">â€¦</p>
    </header>

    <section class="card">
      <div class="row"><div class="label">CelkovÃ½ Äas</div><div class="mono" id="finalTime">â€”</div></div>
      <div class="row"><div class="label">NÃ¡povÄ›dy</div><div class="mono" id="finalHints">â€”</div></div>
      <div class="row"><div class="label">Bonus</div><div class="mono" id="finalBonus">â€”</div></div>

      <div class="divider"></div>

      <div class="label" style="margin-bottom:6px;">NÃ¡zev tÃ½mu (pro leaderboard)</div>
      <input id="teamNameEnd" class="input" placeholder="NapÅ™. NoÄnÃ­ hlÃ­dka" autocomplete="off" />

      <div style="height:10px;"></div>

      <button class="btn primary" id="btnSubmitScore">ğŸ† Odeslat do leaderboardu</button>
      <a class="btn" href="leaderboard.html">Zobrazit leaderboard</a>

<div class="divider"></div>

<button class="btn" id="btnCopy">ZkopÃ­rovat vÃ½sledek</button>
<a class="btn" href="index.html" id="btnAgain">HrÃ¡t znovu</a>
    </section>
  </main>

  <script type="module">
  import { loadSession, formatTime } from "./assets/js/storage.js";

  // ====== CONFIG: doplÅˆ svoje Supabase Ãºdaje ======
  const SUPABASE_URL = "https://hpawsxioispppkfiridq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwYXdzeGlvaXNwcHBrZmlyaWRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMTY5NTEsImV4cCI6MjA4Nzc5Mjk1MX0.Hts2vRw-u-QQ0cJnKy7lt6cmDeZSLdDp2BuimJ_aPQ0";

  const TEAM_KEY = "reichenberg_teamName_v1";

  const s = loadSession();
  const time = (s?.elapsedSec ?? 0) + (s?.penaltySec ?? 0);

  document.getElementById("finalTime").textContent = formatTime(time);
  document.getElementById("finalHints").textContent = String(s?.hintsUsed ?? 0);
  document.getElementById("finalBonus").textContent = s?.bonusCompleted ? "splnÄ›n âœ…" : "nesplnÄ›n";

  document.getElementById("endingText").textContent =
    "Wiedermaier odhalil padÄ›lky. MecenÃ¡Å¡ se bÃ¡l skandÃ¡lu â€” a proto sÃ¡hl po nÃ¡silÃ­.";

  // ====== Copy result ======
  document.getElementById("btnCopy").onclick = async () => {
    const text = `VraÅ¾da v Reichenbergu â€” Äas ${formatTime(time)}, nÃ¡povÄ›dy ${s?.hintsUsed ?? 0}, bonus ${s?.bonusCompleted ? "ano" : "ne"}.`;
    try { await navigator.clipboard.writeText(text); alert("ZkopÃ­rovÃ¡no."); }
    catch { prompt("ZkopÃ­ruj ruÄnÄ›:", text); }
  };

  // ====== Leaderboard submit ======
  const teamEl = document.getElementById("teamNameEnd");
  const btnSubmit = document.getElementById("btnSubmitScore");

  // pÅ™edvyplÅˆ team name z localStorage (pokud ho sbÃ­rÃ¡Å¡ na startu)
  const teamDefault = (localStorage.getItem(TEAM_KEY) || "").trim();
  if(teamEl) teamEl.value = teamDefault;

  function safeTeamName(){
    const name = (teamEl?.value || "").trim();
    return name.length ? name : "Bez nÃ¡zvu";
  }

  async function submitScore(){
    const payload = {
      team_name: safeTeamName(),
      time_sec: Math.max(0, Number(time) || 0),
      hints_used: Number(s?.hintsUsed || 0),
      bonus_completed: !!s?.bonusCompleted
    };

    const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        apikey: SUPABASE_ANON_KEY,
        authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        prefer: "return=minimal"
      },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(`Submit failed: ${res.status} ${t}`);
    }
  }

  if(btnSubmit){
    btnSubmit.onclick = async ()=>{
      btnSubmit.disabled = true;
      btnSubmit.textContent = "OdesÃ­lÃ¡mâ€¦";
      try{
        await submitScore();
        localStorage.setItem(TEAM_KEY, safeTeamName());
        btnSubmit.textContent = "âœ… OdeslÃ¡no! OtevÃ­rÃ¡m leaderboardâ€¦";
        setTimeout(()=> location.href="leaderboard.html", 600);
      } catch(e){
        btnSubmit.disabled = false;
        btnSubmit.textContent = "ğŸ† Odeslat do leaderboardu";
        alert(e.message);
      }
    };
  }
</script>
</body>

</html>

